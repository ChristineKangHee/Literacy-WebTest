<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ê¸€ë‘ ë¬¸í•´ë ¥ ë¯¸ë‹ˆ í…ŒìŠ¤íŠ¸</title>

<!-- âœ… ì¹´í†¡/ë©”ì‹ ì € ë¯¸ë¦¬ë³´ê¸°ìš© OG/Twitter ë©”íƒ€ -->
<meta name="description" content="8ë¬¸í•­ 1ë¶„ì»·! ì–´íœ˜Â·ë…í•´Â·ë¬¸ë²•Â·ë…¼ë¦¬ë¡œ ë‚˜ì˜ ë¬¸í•´ë ¥ ìºë¦­í„°ë¥¼ ë½‘ì•„ë³´ì„¸ìš”." />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="ê¸€ë‘(GLANG)" />
<meta property="og:locale" content="ko_KR" />
<meta property="og:title" content="ê¸€ë‘ ë¬¸í•´ë ¥ ë¯¸ë‹ˆ í…ŒìŠ¤íŠ¸ â€“ ë‚˜ì˜ ë¬¸í•´ë ¥ ìºë¦­í„° ì°¾ê¸°" />
<meta property="og:description" content="8ë¬¸í•­ ë¬¸í•´ë ¥ í…ŒìŠ¤íŠ¸ë¡œ ë‚˜ì˜ ì½ê¸° ê°•ì ì„ í™•ì¸í•˜ê³ , 6ê°€ì§€ ìºë¦­í„° ê²°ê³¼ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!" />
<meta property="og:url" content="https://zeroglang.com/" />
<meta property="og:image" content="https://zeroglang.com/og/1200x630.jpg" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="ê¸€ë‘ ë¬¸í•´ë ¥ ë¯¸ë‹ˆ í…ŒìŠ¤íŠ¸ â€“ ë‚˜ì˜ ë¬¸í•´ë ¥ ìºë¦­í„° ì°¾ê¸°" />
<meta name="twitter:description" content="1ë¶„ ì»· ë¬¸í•´ë ¥ í…ŒìŠ¤íŠ¸ Â· ì–´íœ˜/ë…í•´/ë¬¸ë²•/ë…¼ë¦¬ ì§„ë‹¨ & 6ê°€ì§€ ìºë¦­í„° ê²°ê³¼" />
<meta name="twitter:image" content="https://zeroglang.com/og/1200x630.jpg" />
<link rel="canonical" href="https://zeroglang.com/" />

<style>
  :root{ --tap:44px; }
  html,body{height:100%;margin:0;background:#E5E8F1;}
  body{
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100svh;
  }

  /* âœ… PCì—ì„œë„ í°ì²˜ëŸ¼ ë³´ì´ë„ë¡: í­ ì œí•œ + ê°€ìš´ë° ì •ë ¬ */
  .stage{
    position:relative;
    width:min(100vw, 430px);
    height:100svh;
    max-height:1600px;
    overflow:hidden; /* âœ… ê¸°ë³¸ì€ ìŠ¤í¬ë¡¤ ì—†ìŒ */
    background:#E5E8F1;
  }

  .bg{
    position:absolute; inset:0;
    background:#E5E8F1 center/contain no-repeat; /* JSê°€ í™”ë©´ë³„ë¡œ cover/contain/fit-width ì„¤ì • */
  }

  /* âœ… ê²°ê³¼ë§Œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ ëª¨ë“œ */
  .stage.scroll{
    overflow:visible;           /* body ìŠ¤í¬ë¡¤ */
    max-height:none !important; /* ì•„ë˜ê°€ ëŠê¸°ëŠ” í˜„ìƒ ë°©ì§€ */
  }
  .bg.scroll{
    background-position:center top;
  }
  body.scroll-align-top{
    align-items:flex-start;
  }

  /* í•«ìŠ¤íŒŸ */
  .hotspot{
    position:absolute; display:block; border:none; background:transparent;
    padding:0; margin:0; cursor:pointer;
    min-width:var(--tap); min-height:var(--tap);
    touch-action:manipulation;
  }
  .hotspot:focus-visible{
    outline:2px dashed rgba(40,120,255,.8);
    outline-offset:2px; border-radius:12px;
  }

  /* ë¹„í´ë¦­ ê³ ì • ì˜ì—­(ì ìˆ˜ ë“±) */
  .spot{
    position:absolute; display:flex; align-items:center; justify-content:center;
    background:transparent; pointer-events:none; text-align:center;
  }

  /* ë””ë²„ê·¸ ëª¨ë“œ (D í‚¤ ë˜ëŠ” ?debug=1) */
  .debug .hotspot,
  .debug .spot{ outline:1px dashed rgba(0,0,0,.25); background:rgba(0,128,255,.06); }
  .debug .hotspot::after{
    content:attr(aria-label);
    position:absolute; left:0; top:-1.6em;
    font:600 12px/1.2 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
    color:#0b61ff; background:#fff; border:1px solid #cfe3ff; border-radius:6px; padding:.15em .4em;
    white-space:nowrap; pointer-events:none;
  }

  /* í† ìŠ¤íŠ¸ */
  .toast{
    position:absolute; left:50%; transform:translate(-50%, 8px);
    bottom:18px; padding:.7em 1em; border-radius:10px;
    font:600 14px/1.2 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
    background:#fff; color:#1b2b4a;
    box-shadow:0 8px 32px rgba(0,0,0,.08);
    opacity:0; pointer-events:none;
    transition:opacity .18s ease, transform .18s ease;
  }
  .toast.show{ opacity:1; transform:translate(-50%, 0); }
  .toast.ok  { background:#E9FFF3; color:#0A6F3C; box-shadow:0 8px 32px rgba(2,128,70,.12); }
  .toast.bad { background:#FFEEEE; color:#A3002A; box-shadow:0 8px 32px rgba(163,0,42,.14); }

  .score{
    font:700 13px/1 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
    color:#ffffff; letter-spacing:.2px;
    white-space:nowrap;
  }
</style>

<!-- Google tag (gtag.js) â€” GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TT0E9NJKH8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-TT0E9NJKH8');
</script>
</head>

<body>
  <main id="app" class="stage" aria-live="polite">
    <div id="bg" class="bg"></div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </main>

<script>
/* --------------------------
   0) ìœ í‹¸ & ì´ˆê¸° ì„¤ì •
---------------------------*/
const $ = sel => document.querySelector(sel);
const params = new URLSearchParams(location.search);
const DEBUG = params.get('debug') === '1';
if (DEBUG) document.body.classList.add('debug');
window.addEventListener('keydown', e=>{
  if (e.key.toLowerCase() === 'd') document.body.classList.toggle('debug');
});

// í”Œë«í¼ë³„ ìŠ¤í† ì–´ ë§í¬
const STORE = {
  android: 'https://play.google.com/store/apps/details?id=com.zero.glang&pcampaignid=web_share',
  ios: 'https://apps.apple.com/kr/app/%EA%B8%80%EB%9E%91-glang/id6740841063'
};
function isIOS(){
  const ua=navigator.userAgent||'';
  const iOSClassic=/iPhone|iPad|iPod/i.test(ua);
  const iPadLikeMac=/Macintosh/i.test(ua) && 'ontouchend' in document;
  return iOSClassic || iPadLikeMac;
}
function openStore(){ window.open(isIOS()?STORE.ios:STORE.android,'_blank','noopener'); }

/* âœ… GA ê¸°ë¡ìš©: ì„ íƒì§€ ë²ˆí˜¸ ì¶”ì¶œ (a/b/c/d â†’ 1~4, O/X â†’ 1/2) */
function choiceIndexOfHotspot(h){
  const m = (h?.id || '').match(/_(a|b|c|d)$/i);
  if (m) return ({a:1,b:2,c:3,d:4})[m[1].toLowerCase()];
  if ((h?.id || '').endsWith('_o')) return 1;
  if ((h?.id || '').endsWith('_x')) return 2;
  return null;
}

/* --------------------------
   1) ë°ì´í„° (ì´ë¯¸ì§€ + í•«ìŠ¤íŒŸ)
---------------------------*/
const box = (x,y,w,h)=>({x,y,w,h});

const correct = {
  q1: 'x',
  q2: 'ì˜¤ëŠ˜',
  q3: 'ìš”ì•½ í›ˆë ¨ì´ í•„ìš”í•˜ë‹¤',
  q4: 'o',
  q5: 'í•  ìˆ˜ ìˆë‹¤',
  q6: 'o',
  q7: 'ì „ì œê°€ ì˜ëª»ëë‹¤',
  q8: 'ì½ê³  ì´í•´Â·ë¹„íŒÂ·í‘œí˜„í•˜ëŠ” ì¢…í•© ëŠ¥ë ¥'
};

const RESULT_SCORE_POS_PCT = {
  expression:{ x:68.5, y:27.5, w:22, h:2.5 },
  comp:      { x:68.5, y:27.5, w:22, h:2.5 },
  focus:     { x:68.5, y:27.5, w:22, h:2.5 },
  grammar:   { x:68.5, y:27.5, w:22, h:2.5 },
  logic:     { x:68.5, y:27.5, w:22, h:2.5 },
  vocab:     { x:68.5, y:27.5, w:22, h:2.5 },
};

function resultLabelByKey(key){
  return ({
    expression:'í‘œí˜„ í¬ë¦¬ì—ì´í„°',
    comp:'ë…í•´ íƒìƒ‰ì',
    focus:'ì§‘ì¤‘ íŒŒì´í„°',
    grammar:'ë¬¸ë²• ê°€ë””ì–¸',
    logic:'ë…¼ë¦¬ í¬ë¦¬í‹°ì»¤',
    vocab:'ì–´íœ˜ ë§ˆìŠ¤í„°'
  })[key] || 'ë¬¸í•´ë ¥ ìºë¦­í„°';
}

const screens = [
  { id:'intro', img:'assets/intro.jpg',
    hotspots:[ {id:'start',label:'START',rect:box(22,73,56,7),on:'next'} ] },

  { id:'q1', img:'assets/q1.jpg',
    hotspots:[
      {id:'q1_o',label:'O',rect:box(5,47,90,8),on:'answer:o'},
      {id:'q1_x',label:'X',rect:box(5,57,90,8),on:'answer:x'},
    ]},

  { id:'q2', img:'assets/q2.jpg',
    hotspots:[
      {id:'q2_a',label:'ì˜¤ëŠ˜',rect:box(5,37,90,8),on:'answer:ì˜¤ëŠ˜'},
      {id:'q2_b',label:'ë‚´ì¼',rect:box(5,47,90,8),on:'answer:ë‚´ì¼'},
      {id:'q2_c',label:'ì´ë²ˆ ì£¼',rect:box(5,58,90,8),on:'answer:ì´ë²ˆ ì£¼'},
      {id:'q2_d',label:'ìš”ì¦˜',rect:box(5,68,90,8),on:'answer:ìš”ì¦˜'},
    ]},

  { id:'q3', img:'assets/q3.jpg',
    hotspots:[
      {id:'q3_a',label:'ê¸´ ê¸€ì€ ì½ì§€ ë§ì',rect:box(5,41,90,8),on:'answer:ê¸´ ê¸€ì€ ì½ì§€ ë§ì'},
      {id:'q3_b',label:'ìš”ì•½ í›ˆë ¨ì´ í•„ìš”í•˜ë‹¤',rect:box(5,51,90,8),on:'answer:ìš”ì•½ í›ˆë ¨ì´ í•„ìš”í•˜ë‹¤'},
      {id:'q3_c',label:'ëª¨ë“  ê¸€ì„ ë˜‘ê°™ì´ ì½ì–´ì•¼ í•œë‹¤',rect:box(5,62,90,8),on:'answer:ëª¨ë“  ê¸€ì„ ë˜‘ê°™ì´ ì½ì–´ì•¼ í•œë‹¤'},
      {id:'q3_d',label:'ì§§ì€ ê¸€ì€ ì‰¬ìš´ ê¸€ì´ë‹¤',rect:box(5,72,90,8),on:'answer:ì§§ì€ ê¸€ì€ ì‰¬ìš´ ê¸€ì´ë‹¤'},
    ]},

  { id:'q4', img:'assets/q4.jpg',
    hotspots:[
      {id:'q4_o',label:'O',rect:box(5,48,90,8),on:'answer:o'},
      {id:'q4_x',label:'X',rect:box(5,59,90,8),on:'answer:x'},
    ]},

  { id:'q5', img:'assets/q5.jpg',
    hotspots:[
      {id:'q5_a',label:'í•  ìˆ˜ ìˆë‹¤',rect:box(5,38,90,8),on:'answer:í•  ìˆ˜ ìˆë‹¤'},
      {id:'q5_b',label:'í• ìˆ˜ìˆë‹¤',rect:box(5,48,90,8),on:'answer:í• ìˆ˜ìˆë‹¤'},
      {id:'q5_c',label:'í• ìˆ˜ ìˆë‹¤',rect:box(5,59,90,8),on:'answer:í• ìˆ˜ ìˆë‹¤'},
      {id:'q5_d',label:'í•  ìˆ˜ìˆë‹¤',rect:box(5,69,90,8),on:'answer:í•  ìˆ˜ìˆë‹¤'},
    ]},

  { id:'q6', img:'assets/q6.jpg',
    hotspots:[
      {id:'q6_o',label:'O',rect:box(5,48,90,8),on:'answer:o'},
      {id:'q6_x',label:'X',rect:box(5,59,90,8),on:'answer:x'},
    ]},

  { id:'q7', img:'assets/q7.jpg',
    hotspots:[
      {id:'q7_a',label:'ì‚¬ì‹¤ê³¼ ì˜ê²¬ì´ ì„ì˜€ë‹¤',rect:box(5,38,90,8),on:'answer:ì‚¬ì‹¤ê³¼ ì˜ê²¬ì´ ì„ì˜€ë‹¤'},
      {id:'q7_b',label:'ì „ì œê°€ ì˜ëª»ëë‹¤',rect:box(5,48,90,8),on:'answer:ì „ì œê°€ ì˜ëª»ëë‹¤'},
      {id:'q7_c',label:'ë…¼ë¦¬ì ìœ¼ë¡œ ì™„ë²½í•˜ë‹¤',rect:box(5,59,90,8),on:'answer:ë…¼ë¦¬ì ìœ¼ë¡œ ì™„ë²½í•˜ë‹¤'},
      {id:'q7_d',label:'ê²°ë¡ ì´ ì ì ˆí•˜ë‹¤',rect:box(5,69,90,8),on:'answer:ê²°ë¡ ì´ ì ì ˆí•˜ë‹¤'},
    ]},

  { id:'q8', img:'assets/q8.jpg',
    hotspots:[
      {id:'q8_a',label:'ê¸€ì„ ì½ê³  ì“¸ ìˆ˜ ìˆëŠ” ëŠ¥ë ¥',rect:box(5,38,90,8),on:'answer:ê¸€ì„ ì½ê³  ì“¸ ìˆ˜ ìˆëŠ” ëŠ¥ë ¥'},
      {id:'q8_b',label:'ì½ê³  ì´í•´Â·ë¹„íŒÂ·í‘œí˜„í•˜ëŠ” ì¢…í•© ëŠ¥ë ¥',rect:box(5,48,90,8),on:'answer:ì½ê³  ì´í•´Â·ë¹„íŒÂ·í‘œí˜„í•˜ëŠ” ì¢…í•© ëŠ¥ë ¥'},
      {id:'q8_c',label:'ê¸€ìë¥¼ ë§ì´ ì•„ëŠ” ëŠ¥ë ¥',rect:box(5,59,90,8),on:'answer:ê¸€ìë¥¼ ë§ì´ ì•„ëŠ” ëŠ¥ë ¥'},
      {id:'q8_d',label:'ê¸´ ê¸€ì„ ëê¹Œì§€ ì½ëŠ” ëˆê¸°',rect:box(5,69,90,8),on:'answer:ê¸´ ê¸€ì„ ëê¹Œì§€ ì½ëŠ” ëˆê¸°'},
    ]},

  { id:'result', img:'assets/result/expression.jpg',
    hotspots:[
      { id:'share',     label:'SHARE',      rect:box(17.4,44.2,25.9,3.1), on:'share' },
      { id:'restart',   label:'RESTART',    rect:box(55.9,44.2,25.1,3.1), on:'restart' },
      { id:'instagram', label:'Instagram',  rect:box(37.7,92.4,11.9,3.1), on:'instagram' },
      { id:'glang',     label:'Glang Logo', rect:box(50.2,92.4,10.3,3.1), on:'glang' },
    ]
  }
];

/* --------------------------
   2) ìƒíƒœ & ì§„í–‰
---------------------------*/
const state = { index:0, answers:{}, score:null };

const $bg = $('#bg');
const $stage = $('#app');
const $toast = $('#toast');
let LOCK = false;

let _lastTrackedIndex = -1;
function trackScreen() {
  if (typeof gtag !== 'function') return;
  if (_lastTrackedIndex === state.index) return;
  const scr = screens[state.index];
  if (!scr) return;
  gtag('event', 'screen_view', { screen_name: scr.id });
  _lastTrackedIndex = state.index;
}

function showToast(msg, type='ok', duration=900, onHide){
  $toast.className = 'toast';
  if (type) $toast.classList.add(type);
  $toast.textContent = msg;
  $toast.classList.add('show');
  setTimeout(()=>{
    $toast.classList.remove('show','ok','bad');
    if (typeof onHide === 'function') onHide();
  }, duration);
}

function calcScore(answers){
  const isRight = q => answers[q] === correct[q];
  const count = {
    vocab:   (isRight('q1')?1:0) + (isRight('q2')?1:0),
    comp:    (isRight('q3')?1:0) + (isRight('q4')?1:0),
    grammar: (isRight('q5')?1:0) + (isRight('q6')?1:0),
    logic:   (isRight('q7')?1:0),
  };
  const totalCorrect = count.vocab + count.comp + count.grammar + count.logic + (isRight('q8')?1:0);
  return { totalCorrect, count };
}

/* --------------------------
   2-1) ì´ë¯¸ì§€ ë©”íƒ€ & ë ˆì´ì•„ì›ƒ ëª¨ë“œ
---------------------------*/
const _imgMetaCache = new Map();
function getImageMeta(src){
  return new Promise((resolve)=>{
    if (_imgMetaCache.has(src)) return resolve(_imgMetaCache.get(src));
    const im = new Image();
    im.onload = ()=>{ const meta={w:im.naturalWidth,h:im.naturalHeight}; _imgMetaCache.set(src,meta); resolve(meta); };
    im.src = src;
  });
}

/* âœ… êµì²´ ì½”ë“œ: ì‚¬íŒŒë¦¬/í¬ë¡¬/ì¹´í†¡ ì¸ì•± ì›¹ë·°ê¹Œì§€ ì•ˆì •ì ìœ¼ë¡œ ëª¨ë°”ì¼ íŒì • */
function isMobile(){
  const vw = Math.min(window.innerWidth || 0, document.documentElement.clientWidth || 0);
  const ua = (navigator.userAgent || '').toLowerCase();

  const uaMobile =
    /iphone|ipod|ipad|android|mobile/.test(ua) ||
    /kakaotalk/.test(ua);

  return vw <= 767 || (uaMobile && vw <= 900);
}

/**
 * ë ˆì´ì•„ì›ƒ ì •ì±…
 * - result: fit-width(ê°€ë¡œ 100%) + top ì •ë ¬ + í•„ìš” ì‹œ ìŠ¤í¬ë¡¤
 * - others:
 *    - ëª¨ë°”ì¼: cover(center) => ì–‘ì˜† ê½‰, ìœ„/ì•„ë˜ ì˜ë ¤ë„ OK
 *    - PC: contain(center)  => ì „ì²´ ë³´ì´ê²Œ, ê°€ìš´ë° ì •ë ¬
 */
function getLayoutMode(scr){
  if (scr?.id === 'result') return 'FIT_WIDTH_TOP';
  return isMobile() ? 'COVER_CENTER' : 'CONTAIN_CENTER';
}

function applyBgStyleByMode(mode){
  if (mode === 'FIT_WIDTH_TOP'){
    $bg.style.backgroundSize = '100% auto';
    $bg.style.backgroundPosition = 'center top';
    return;
  }
  if (mode === 'COVER_CENTER'){
    $bg.style.backgroundSize = 'cover';
    $bg.style.backgroundPosition = 'center center';
    return;
  }
  $bg.style.backgroundSize = 'contain';
  $bg.style.backgroundPosition = 'center center';
}

/* âœ… modeì— ë§ê²Œ í•«ìŠ¤íŒŸ ì¢Œí‘œ ë§¤í•‘(cover/contain/fit-width ëª¨ë‘ ëŒ€ì‘) */
async function placeOnBg({ stageEl, imgUrl, rectPct, targetEl, mode }){
  const meta = await getImageMeta(imgUrl);
  const sw = stageEl.clientWidth, sh = stageEl.clientHeight;

  let scale, offX, offY;

  if (mode === 'FIT_WIDTH_TOP'){
    scale = sw / meta.w;
    const drawW = meta.w * scale;
    const drawH = meta.h * scale;
    offX = Math.round((sw - drawW)/2);
    offY = 0;
  } else if (mode === 'COVER_CENTER'){
    scale = Math.max(sw/meta.w, sh/meta.h);
    const drawW = meta.w * scale;
    const drawH = meta.h * scale;
    offX = Math.round((sw - drawW)/2);
    offY = Math.round((sh - drawH)/2);
  } else {
    scale = Math.min(sw/meta.w, sh/meta.h);
    const drawW = meta.w * scale;
    const drawH = meta.h * scale;
    offX = Math.round((sw - drawW)/2);
    offY = Math.round((sh - drawH)/2);
  }

  const rx = rectPct.x * meta.w / 100;
  const ry = rectPct.y * meta.h / 100;
  const rw = rectPct.w * meta.w / 100;
  const rh = rectPct.h * meta.h / 100;

  const left   = Math.round(offX + rx * scale);
  const top    = Math.round(offY + ry * scale);
  const width  = Math.round(rw * scale);
  const height = Math.round(rh * scale);

  Object.assign(targetEl.style, { left:left+'px', top:top+'px', width:width+'px', height:height+'px' });
}

/* --------------------------
   ê²°ê³¼ ìŠ¤í¬ë¡¤: resultë§Œ ê¸¸ë©´ ìŠ¤í¬ë¡¤
---------------------------*/
async function needScrollForResult(stageEl, imgUrl){
  const scr = screens[state.index];
  if (scr?.id !== 'result') return false;

  const meta = await getImageMeta(imgUrl);
  const sw = stageEl.clientWidth;
  const scale = sw / meta.w;
  const drawH = meta.h * scale;
  return drawH > window.innerHeight + 1;
}

async function applyScrollModeIfNeeded(){
  const scr = screens[state.index];
  const isResult = scr?.id === 'result';

  // ê¸°ë³¸ í•´ì œ
  $stage.classList.remove('scroll');
  $bg.classList.remove('scroll');
  document.body.classList.remove('scroll-align-top');
  $stage.style.height = '100svh';
  $stage.style.maxHeight = '';

  if (!isResult) return;

  const mustScroll = await needScrollForResult($stage, scr.img);
  if (!mustScroll) return;

  const meta = await getImageMeta(scr.img);
  const sw = $stage.clientWidth;
  const scale = sw / meta.w;
  const drawH = Math.round(meta.h * scale);

  $stage.style.height = drawH + 'px';
  $stage.style.maxHeight = 'none';
  $stage.classList.add('scroll');
  $bg.classList.add('scroll');
  document.body.classList.add('scroll-align-top');
}

/* --------------------------
   3) ë Œë”ë§
---------------------------*/
let _currentImg = null;
let _scoreSpotEl = null;
let _hotspotEls = [];

async function render(){
  const scr = screens[state.index];
  if (!scr) return;

  _currentImg = scr.img;
  $bg.style.backgroundImage = `url("${scr.img}")`;

  const mode = getLayoutMode(scr);
  applyBgStyleByMode(mode);

  // ì´ˆê¸°í™”
  $stage.querySelectorAll('.hotspot, .spot').forEach(el=>el.remove());
  _scoreSpotEl = null;
  _hotspotEls = [];

  // ê²°ê³¼ ìŠ¤í¬ë¡¤ ì ìš©(ê²°ê³¼ë§Œ)
  await applyScrollModeIfNeeded();

  // í•«ìŠ¤íŒŸ ìƒì„± + ë°°ì¹˜
  for (const h of scr.hotspots){
    const btn = document.createElement('button');
    btn.className = 'hotspot';
    btn.setAttribute('aria-label', h.label || h.id);
    btn.style.borderRadius = '12px';

    // âœ… hotspot ë©”íƒ€ë¥¼ handleë¡œ ê°™ì´ ë„˜ê¹€ (GA ì„ íƒì§€ ê¸°ë¡ìš©)
    btn.addEventListener('click', ()=>{
      if(!LOCK) handle(h.on, { screenId: scr.id, hotspot: h });
    });

    $stage.appendChild(btn);

    _hotspotEls.push({ el:btn, rect:h.rect });
    placeOnBg({ stageEl:$stage, imgUrl:_currentImg, rectPct:h.rect, targetEl:btn, mode });
  }

  // ê²°ê³¼ ì ìˆ˜ í‘œì‹œ
  if (scr.id === 'result' && state.score?.total != null){
    const posPct = RESULT_SCORE_POS_PCT[state.score.key] || RESULT_SCORE_POS_PCT.comp;
    const spot = document.createElement('div');
    spot.className = 'spot score';
    spot.textContent = `${state.score.total}/${state.score.outOf}`;
    spot.style.borderRadius = '12px';
    $stage.appendChild(spot);
    _scoreSpotEl = spot;

    placeOnBg({ stageEl:$stage, imgUrl:_currentImg, rectPct:posPct, targetEl:spot, mode });
  }

  trackScreen();
}

/* âœ… ë¦¬ë ˆì´ì•„ì›ƒ/ì¬ë°°ì¹˜: íˆ´ë°” show/hide(ë†’ì´ë§Œ ë³€ê²½)ëŠ” ìŠ¤í¬ë¡¤ íŠ•ê¹€ì´ ë‚˜ì„œ "ì¬ë°°ì¹˜ë§Œ" */
let _relayoutRAF = 0;
let _repositionRAF = 0;

function requestRepositionOnly(){
  cancelAnimationFrame(_repositionRAF);
  _repositionRAF = requestAnimationFrame(async ()=>{
    if (!_currentImg) return;

    const scr = screens[state.index];
    const mode = getLayoutMode(scr);

    _hotspotEls.forEach(({el, rect})=>{
      placeOnBg({ stageEl:$stage, imgUrl:_currentImg, rectPct:rect, targetEl:el, mode });
    });

    if (_scoreSpotEl && scr?.id === 'result' && state.score){
      const posPct = RESULT_SCORE_POS_PCT[state.score.key] || RESULT_SCORE_POS_PCT.comp;
      placeOnBg({ stageEl:$stage, imgUrl:_currentImg, rectPct:posPct, targetEl:_scoreSpotEl, mode });
    }
  });
}

function requestRelayout(){
  cancelAnimationFrame(_relayoutRAF);
  _relayoutRAF = requestAnimationFrame(async ()=>{
    if (!_currentImg) return;

    const scr = screens[state.index];

    // âœ… ê²°ê³¼ í™”ë©´ì´ë©´ í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ (í­ ë³€ê²½/íšŒì „ ì‹œ íŠ ë°©ì§€)
    const prevY = (scr?.id === 'result') ? window.scrollY : 0;

    const mode = getLayoutMode(scr);
    applyBgStyleByMode(mode);
    await applyScrollModeIfNeeded();

    _hotspotEls.forEach(({el, rect})=>{
      placeOnBg({ stageEl:$stage, imgUrl:_currentImg, rectPct:rect, targetEl:el, mode });
    });

    if (_scoreSpotEl && scr?.id === 'result' && state.score){
      const posPct = RESULT_SCORE_POS_PCT[state.score.key] || RESULT_SCORE_POS_PCT.comp;
      placeOnBg({ stageEl:$stage, imgUrl:_currentImg, rectPct:posPct, targetEl:_scoreSpotEl, mode });
    }

    // âœ… ê²°ê³¼ í™”ë©´ì´ë©´ ìŠ¤í¬ë¡¤ ë³µêµ¬
    if (scr?.id === 'result') window.scrollTo(0, prevY);
  });
}

/* âœ… "í­ì´ ë³€í–ˆëŠ”ì§€"ë¡œë§Œ ì§„ì§œ relayoutì„ íŒë‹¨ */
let _lastVW = 0;
let _lastVH = 0;

function getVV(){
  const vv = window.visualViewport;
  const w = Math.round((vv?.width ?? window.innerWidth) * 10) / 10;
  const h = Math.round((vv?.height ?? window.innerHeight) * 10) / 10;
  return { w, h };
}
function didWidthChange(){
  const { w, h } = getVV();
  const widthChanged  = Math.abs(w - _lastVW) >= 1;
  const heightChanged = Math.abs(h - _lastVH) >= 1;
  _lastVW = w; _lastVH = h;
  return { widthChanged, heightChanged };
}
function onViewportMaybeChanged(){
  const scr = screens[state.index];
  const { widthChanged } = didWidthChange();

  if (scr?.id !== 'result'){
    requestRelayout();
    return;
  }

  // âœ… ê²°ê³¼ í™”ë©´:
  // - í­ ë³€ê²½(íšŒì „/ë¦¬ì‚¬ì´ì¦ˆ ë“±)ë§Œ relayout
  // - ë†’ì´ë§Œ ë³€ê²½(ì¹´í†¡ ìƒ/í•˜ë‹¨ë°”)ë©´ ì¬ë°°ì¹˜ë§Œ
  if (widthChanged) requestRelayout();
  else requestRepositionOnly();
}

// ì´ˆê¸° ìŠ¤ëƒ…ìƒ·
(() => {
  const { w, h } = getVV();
  _lastVW = w; _lastVH = h;
})();

// window ì´ë²¤íŠ¸
window.addEventListener('resize', onViewportMaybeChanged);
window.addEventListener('orientationchange', onViewportMaybeChanged);
window.addEventListener('pageshow', onViewportMaybeChanged);

// iOS Safari/ì¹´ì¹´ì˜¤í†¡ ì¸ì•± ì›¹ë·° ëŒ€ì‘
if (window.visualViewport){
  visualViewport.addEventListener('resize', onViewportMaybeChanged);
  // íˆ´ë°” ì ‘í˜/í¼ì¹¨ì—ì„œ scroll ì´ë²¤íŠ¸ë¡œë„ viewportê°€ ë³€í•˜ëŠ” ê²½ìš° â†’ ì¬ë°°ì¹˜ë§Œ
  visualViewport.addEventListener('scroll', requestRepositionOnly);
}

/* --------------------------
   4) ì§„í–‰/ì•¡ì…˜
---------------------------*/
function buildShareData(){
  const key = state.score?.key;
  const label = resultLabelByKey(key);
  const url = 'https://zeroglang.com/';
  const text = [
    `ë‚˜ëŠ” ${label}!`,
    'ë”± 1ë¶„ë§Œ íˆ¬ìí•˜ë©´ ë‚´ ë¬¸í•´ë ¥ ìºë¦­í„°ê°€ ë½‘íŒë‹¤!',
    'ê²°ê³¼ëŠ” ì¹œêµ¬ë‘ ê³µìœ í•˜ê³  ëˆ„ê°€ ë” ë˜‘ë˜‘í•œì§€ ëŒ€ê²° ê³ ê³ ì”½~',
    `ğŸ‘‰ í…ŒìŠ¤íŠ¸í•˜ëŸ¬ ê°€ê¸°: ${url}`
  ].join('\n');
  return { text };
}

function next(){
  state.index++;

  if (state.index >= screens.length - 1){
    state.index = screens.length - 1;

    const { totalCorrect } = calcScore(state.answers);
    state.score = { total: totalCorrect, outOf: 8 };

    const resultKey = chooseResult(state.answers);
    const resultImg = resultImageByKey(resultKey);
    screens[state.index].img = resultImg;
    state.score.key = resultKey;

    // âœ… GA4: í€´ì¦ˆ ì™„ë£Œ(ì ìˆ˜ + ê²°ê³¼ ìºë¦­í„°) ê¸°ë¡
    if (typeof gtag === 'function') {
      gtag('event', 'quiz_complete', {
        quiz_id: 'glang_mini_8q',
        total_correct: state.score.total,
        total_questions: state.score.outOf,
        score_text: `${state.score.total}/${state.score.outOf}`,
        result_key: state.score.key,
        result_label: resultLabelByKey(state.score.key),
        page_location: location.href
      });

      // (ì›í•˜ë©´ ë³„ë„ ì´ë²¤íŠ¸ë¡œë„ ë¶„ë¦¬ ê°€ëŠ¥)
      gtag('event', 'quiz_result', {
        quiz_id: 'glang_mini_8q',
        total_correct: state.score.total,
        total_questions: state.score.outOf,
        score_text: `${state.score.total}/${state.score.outOf}`,
        result_key: state.score.key,
        result_label: resultLabelByKey(state.score.key),
        page_location: location.href
      });
    }
  }

  render();
  requestRelayout(); // âœ… ì²« ë Œë” ì§í›„ ì¬ë³´ì •(START í¬í•¨ í•«ìŠ¤íŒŸ)
}

/* âœ… handle(action, meta) : metaì— hotspot ì •ë³´ê°€ ë“¤ì–´ì˜´ */
function handle(action, meta){
  if (!action) return;

  if (typeof gtag === 'function') {
    gtag('event', 'ui_action', {
      action,
      screen_id: meta?.screenId || screens[state.index]?.id,
      hotspot_id: meta?.hotspot?.id || null,
      page_location: location.href
    });
  }

  if (action === 'next'){
    if (typeof gtag === 'function') gtag('event', 'start_quiz', { quiz_id:'glang_mini_8q' });
    next();
    return;
  }

  if (action.startsWith('answer:')){
    const val = action.split(':')[1];
    const qid = screens[state.index].id;
    state.answers[qid] = val;

    const h = meta?.hotspot;
    const choice_index = choiceIndexOfHotspot(h); // âœ… 1~4 / OX(1,2)
    const choice_id = h?.id || null;
    const choice_label = h?.label || val;

    if (Object.prototype.hasOwnProperty.call(correct, qid)){
      const ok = correct[qid] === val;

      // âœ… GA4: "ëª‡ë²ˆ ì„ íƒì§€" + "ì •ë‹µì—¬ë¶€" + "ì„ íƒ í…ìŠ¤íŠ¸" ê¸°ë¡
      if (typeof gtag === 'function') {
        gtag('event', 'select_choice', {
          quiz_id: 'glang_mini_8q',
          question_id: qid,
          choice_id,
          choice_index,
          choice_text: choice_label,
          is_correct: ok ? 1 : 0,
          page_location: location.href
        });

        // (ê¸°ì¡´ answer ì´ë²¤íŠ¸ë„ ìœ ì§€í•˜ê³  ì‹¶ìœ¼ë©´ ê°™ì´)
        gtag('event', 'answer', {
          qid,
          value: val,
          result: ok ? 'correct' : 'wrong'
        });
      }

      LOCK = true;
      showToast(ok ? 'ğŸ‘ ì •ë‹µ' : 'âŒ ì˜¤ë‹µ', ok ? 'ok' : 'bad', 900, ()=>{
        LOCK = false; next();
      });
    } else {
      next();
    }
    return;
  }

  if (action === 'share'){
    if (typeof gtag === 'function') {
      gtag('event', 'share_click', {
        quiz_id:'glang_mini_8q',
        result_key: state.score?.key || null,
        score_text: (state.score?.total!=null && state.score?.outOf!=null) ? `${state.score.total}/${state.score.outOf}` : null,
        page_location: location.href
      });
    }
    const data = buildShareData();
    if (navigator.share){
      navigator.share(data).catch(()=>{});
    } else {
      navigator.clipboard?.writeText(data.text);
      showToast('ê³µìœ  ë¬¸êµ¬ê°€ ë³µì‚¬ë˜ì—ˆì–´ìš”', 'ok', 1200);
    }
    return;
  }

  if (action === 'restart'){
    if (typeof gtag === 'function') gtag('event', 'restart', { quiz_id:'glang_mini_8q' });
    state.index = 0;
    state.answers = {};
    state.score = null;

    // ìŠ¤í¬ë¡¤ë„ ìœ„ë¡œ ì˜¬ë ¤ ì´ˆê¸°í™” ëŠë‚Œ í™•ì‹¤íˆ
    window.scrollTo(0, 0);

    render();
    requestRelayout();
    return;
  }

  if (action === 'instagram'){
    if (typeof gtag === 'function') gtag('event', 'external_instagram', { page_location: location.href });
    window.open('https://www.instagram.com/glang.official', '_blank','noopener');
    return;
  }

  if (action === 'glang'){
    if (typeof gtag === 'function') gtag('event', 'store_visit', { platform: isIOS()?'ios':'android' });
    openStore();
    return;
  }
}

/* --------------------------
   5) ê²°ê³¼ ì‚°ì¶œ
---------------------------*/
function chooseResult(answers){
  const isRight = q => answers[q] === correct[q];
  const count = {
    vocab:   (isRight('q1')?1:0) + (isRight('q2')?1:0),
    comp:    (isRight('q3')?1:0) + (isRight('q4')?1:0),
    grammar: (isRight('q5')?1:0) + (isRight('q6')?1:0),
    logic:   (isRight('q7')?1:0)
  };
  const totalCorrect = count.vocab + count.comp + count.grammar + count.logic + (isRight('q8')?1:0);

  if (totalCorrect === 8) return 'expression';

  const maxCnt = Math.max(count.vocab, count.comp, count.grammar, count.logic);
  let winners = Object.entries(count).filter(([,v])=>v===maxCnt).map(([k])=>k);

  if (winners.includes('logic') && isRight('q7')) return 'focus';
  if (winners.length>1 && isRight('q8') && winners.includes('comp')) winners=['comp'];

  const priority=['vocab','comp','grammar','logic'];
  const picked = winners.sort((a,b)=>priority.indexOf(a)-priority.indexOf(b))[0];

  switch(picked){
    case 'vocab':   return 'vocab';
    case 'comp':    return 'comp';
    case 'grammar': return 'grammar';
    case 'logic':   return 'logic';
    default:        return 'comp';
  }
}

function resultImageByKey(key){
  const map = {
    expression:'assets/result/expression.jpg',
    logic:'assets/result/logic.jpg',
    focus:'assets/result/focus.jpg',
    vocab:'assets/result/vocab.jpg',
    grammar:'assets/result/grammar.jpg',
    comp:'assets/result/compreh.jpg'
  };
  return map[key] || map.expression;
}

/* --------------------------
   6) ì‹œì‘
---------------------------*/
render();
</script>
</body>
</html>
